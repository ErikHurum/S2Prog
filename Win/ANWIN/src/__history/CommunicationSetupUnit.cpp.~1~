#include <vcl.h>
#include "ConstantsANWIN.h"
#include "TSNIncludes.h"
#include "MainUnit.h"
#pragma hdrstop

#include "CommunicationSetupUnit.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "nrcommbox"
#pragma resource "*.dfm"
TComSetupDlg *ComSetupDlg;
//---------------------------------------------------------------------------
__fastcall TComSetupDlg::TComSetupDlg(TComponent* Owner)
	: TForm(Owner)
{
	  int comnr =0;
	  if(MainForm->DataSourceName.SubString(0,3) == "Com"){
		DataSourceName = MainForm->DataSourceName;
	  }else if(MainForm->DataSourceName == "Network"){
		DataSourceName = "Network";
		comnr = 1;
		ComParametersPanel->Visible = false;
	  } else if(MainForm->DataSourceName == "AnproNet") {
		DataSourceName = "AnproNet";
		comnr = 2;
		ComParametersPanel->Visible = false;
	  }else if((MainForm->DataSourceName == "NoCom")||(MainForm->DataSourceName == "Com0")){
		DataSourceName = "NoCom";
		comnr = 3;
	  }else if(MainForm->DataSourceName == "Simulator"){
		DataSourceName = "Simulator";
		comnr = 4;
		ComParametersPanel->Visible = false;
	  }
	  switch(MainForm->nrComm1->BaudRate){
		default:
		case 115200:
			BaudrateRadioGroup->ItemIndex = 0;
			break;
		case 57600:
			BaudrateRadioGroup->ItemIndex = 1;
			break;
		case 38400:
			BaudrateRadioGroup->ItemIndex = 2;
			break;

	  }
	  switch(MainForm->nrComm1->StopBits){
		default:
		case sbOne:
			StopBitRadioGroup->ItemIndex = 0;
			break;
		case sbOneAndHalf:
			StopBitRadioGroup->ItemIndex = 1;
			break;
		case sbTwo:
			StopBitRadioGroup->ItemIndex = 2;
			break;

	  }
	  switch(MainForm->nrComm1->Parity){
		default:
		case pNone:
			ParityRadioGroup->ItemIndex = 0;
			break;
		case pOdd:
			ParityRadioGroup->ItemIndex = 1;
			break;
		case pEven:
			ParityRadioGroup->ItemIndex = 2;
			break;

	  }

	  ComRadioGroup->ItemIndex 	   = comnr;
	  InfoLabel->Visible = false;
}
//---------------------------------------------------------------------------
void __fastcall TComSetupDlg::ComRadioGroupClick(TObject *Sender)
{
  switch(ComRadioGroup->ItemIndex){
	case 0:
	  DataSourceName = nrDeviceBox1->Text;
	  IPAdressGroupBox->Visible 	= false;
	  SearchBitBtn->Visible			= true;
	  InfoLabel->Visible 			= false;
	  ComParametersPanel->Visible   = true;
	  break;
	case 1:
	  DataSourceName = "Network";
	  IPAdressGroupBox->Visible 	= false;
	  SearchBitBtn->Visible			= false;
	  InfoLabel->Visible 			= true;
	  ComParametersPanel->Visible   = false;
	  break;
	case 2:
	  DataSourceName = "AnproNet";
	  IPAdressGroupBox->Visible 	= false;
	  SearchBitBtn->Visible			= false;
	  InfoLabel->Visible 			= true;
	  ComParametersPanel->Visible   = false;
	  break;
	case 3:
	  DataSourceName = "NoCom";
	  IPAdressGroupBox->Visible 	= false;
	  SearchBitBtn->Visible			= false;
	  InfoLabel->Visible 			= true;
	  ComParametersPanel->Visible   = false;
	  break;
	case 4:
	  DataSourceName = "Simulator";
//      IPAdressGroupBox->Visible = true;
	  SearchBitBtn->Visible			= false;
	  InfoLabel->Visible 			= true;
	  ComParametersPanel->Visible   = false;
	  break;
  }
}
//---------------------------------------------------------------------------
void __fastcall TComSetupDlg::BitBtn1Click(TObject *Sender)
{
	MainForm->DataSourceName   = DataSourceName;
	switch(BaudrateRadioGroup->ItemIndex){
		default:
		case 0:
			MainForm->nrComm1->BaudRate	= 115200;
			break;
		case 1:
			MainForm->nrComm1->BaudRate	= 57600;
			break;
		case 2:
			MainForm->nrComm1->BaudRate	= 38400;
			break;

	}
	MainForm->BaudRate = MainForm->nrComm1->BaudRate;
	switch(StopBitRadioGroup->ItemIndex){
		default:
		case 0:
			MainForm->nrComm1->StopBits  = sbOne;
			MainForm->StopBits			 = "1";
			break;
		case 1:
			MainForm->nrComm1->StopBits  = sbOneAndHalf;
			MainForm->StopBits			 = "1.5";
			break;
		case 2:
			MainForm->nrComm1->StopBits  = sbTwo;
			MainForm->StopBits			 = "2";
			break;

	}
	  switch(MainForm->nrComm1->Parity){
		default:
		case 0:
			MainForm->nrComm1->Parity = pNone;
			MainForm->Parity		  = "N";
			break;
		case 1:
			MainForm->nrComm1->Parity = pOdd;
			MainForm->Parity		  = "O";
			break;
		case 2:
			MainForm->nrComm1->Parity = pEven;
			MainForm->Parity		  = "E";
			break;

	}

}
//---------------------------------------------------------------------------
void __fastcall TComSetupDlg::FormClose(TObject *Sender,
	  TCloseAction &Action)
{
		Action = caFree;

}
//---------------------------------------------------------------------------
void __fastcall TComSetupDlg::SearchBitBtnClick(TObject *Sender)
{
	MainForm->CurrentSearchComPortIndex			= 0;
	MainForm->FindComPort 		 				= true;
	MainForm->NetReceiveRestartTimer->Enabled 	= true;
}
//---------------------------------------------------------------------------











void __fastcall TComSetupDlg::nrDeviceBox1Change(TObject *Sender)
{
	DataSourceName           = nrDeviceBox1->Text;
	MainForm->DataSourceName = nrDeviceBox1->Text;
}
//---------------------------------------------------------------------------

