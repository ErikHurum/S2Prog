/****************************************************************************************
/   Declars the variable in the project
/
***************************************************************************************/
#include "constants.h"
#include "externals.h"

// system variables
char UnitID;                                // board type
char HostAddress ; 
char MyPriAddress ; 
char MySecAddress ; 
char RestartStatus;                           // mirror of the restart status      
char BlinkStatus;                           // level for blinking

char kbd_delay_cnt;                         // not ripple on keyboard
char tx_status;                             // status for sending ack answer
char RXTimeout;                             // mark for rx error

UARTDataType    UART[2];                    // set ut Uart struct for two CPU ports
volatile DispData Disp;                       // Display data

char  packed_data[PACKED_DATA_SIZE] ;       // packed sensor data 

char TxBufferCh0[ TXSIZE_UART ];            // set up buffer size
char RxBufferCh0[ RXSIZE_UART ];   
 
// eeprom
char WriteCount;   
char *pWriteBuffer;   
char RestoreStat;

// uart 0

// uart 1


__farflash const char crc[] =             /*Dallas Semiconductor one-wire CRC table */
{
    0, 94, 188, 226, 97, 63, 221, 131, 194, 156, 126, 32, 163, 253, 31, 65,
    157, 195, 33, 127, 252, 162, 64, 30, 95, 1, 227, 189, 62, 96, 130, 220,
    35, 125, 159, 193, 66, 28, 254, 160, 225, 191, 93, 3, 128, 222, 60, 98,
    190, 224, 2, 92, 223, 129, 99, 61, 124, 34, 192, 158, 29, 67, 161, 255,
    70, 24, 250, 164, 39, 121, 155, 197, 132, 218, 56, 102, 229, 187, 89, 7,
    219, 133, 103, 57, 186, 228, 6, 88, 25, 71, 165, 251, 120, 38, 196, 154,
    101, 59, 217, 135, 4, 90, 184, 230, 167, 249, 27, 69, 198, 152, 122, 36,
    248, 166, 68, 26, 153, 199, 37, 123, 58, 100, 134, 216, 91, 5, 231, 185,
    140, 210, 48, 110, 237, 179, 81, 15, 78, 16, 242, 172, 47, 113, 147, 205,
    17, 79, 173, 243, 112, 46, 204, 146, 211, 141, 111, 49, 178, 236, 14, 80,
    175, 241, 19, 77, 206, 144, 114, 44, 109, 51, 209, 143, 12, 82, 176, 238,
    50, 108, 142, 208, 83, 13, 239, 177, 240, 174, 76, 18, 145, 207, 45, 115,
    202, 148, 118, 40, 171, 245, 23, 73, 8, 86, 180, 234, 105, 55, 213, 139,
    87, 9, 235, 181, 54, 104, 138, 212, 149, 203, 41, 119, 244, 170, 72, 22,
    233, 183, 85, 11, 136, 214, 52, 106, 43, 117, 151, 201, 74, 20, 246, 168,
    116, 42, 200, 150, 21, 75, 169, 247, 182, 232, 10, 84, 215, 137, 107, 53
} ;

__farflash const char ascii_table[][3][5] =  {
/* Table starts at 20h 
 Table contains:
   {wide char , tiny char , seven_seg char}
    {number of elements, elements from left, noe, efl } Only data for seven-segment*/

    {{ 2, 0x00, 0x00},{ 2, 0x00, 0x00},{0x00}},                         /*    (20) */
    {{ 1, 0x7d},{1, 0x7d},{0x00}},                                      /* !  (21) */
    {{ 3, 0x70, 0x00, 0x70},{ 3, 0x70, 0x00, 0x70},{0x00}},             /* "  (22) */
    {{ 4, 0x1e, 0x74, 0x1e , 0x74},{ 4, 0x1e, 0x74, 0x1e , 0x74},{0x00}},   /* #  (23) */
    {{ 4, 0x12, 0x2f, 0x7a , 0x24},{ 4, 0x12, 0x2f, 0x7a , 0x24},{0x00}},   /* $  (24) */
    {{ 4, 0x33, 0x34, 0x0b , 0x33},{ 4, 0x33, 0x34, 0x0b , 0x33},{0x00}},   /* %  (25) */
    {{ 4, 0x36, 0x49, 0x36 , 0x05},{ 4, 0x36, 0x49, 0x36 , 0x05},{0x00}},   /* &  (26) */
    {{ 1, 0x60},{ 1, 0x60},{0x02}},                                     /* '  (27) */
    {{ 3, 0x1c, 0x22, 0x41},{ 3, 0x1c, 0x22, 0x41},{0x39}},             /* (  (28) */
    {{ 3, 0x41, 0x22, 0x1c},{ 3, 0x41, 0x22, 0x1c},{0x0f}},             /* )  (29) */
    {{ 4, 0x2a, 0x1c, 0x1c, 0x2a},{ 4, 0x2a, 0x1c, 0x1c, 0x2a},{0x00}}, /* *  (2a) */
    {{ 3, 0x08, 0x1c, 0x08},{ 3, 0x08, 0x1c, 0x08},{0x00}},             /* +  (2b) */
    {{ 2, 0x01, 0x06},{ 1, 0x01},{0x00}},                               /* ,  (2c) */
    {{ 3, 0x08, 0x08, 0x08},{ 3, 0x08, 0x08, 0x08},{0x40}},             /* -  (2d) */
    {{ 1, 0x01},{ 1, 0x01},{0x00}},                                     /* .  (2e) */
    {{ 3, 0x07, 0x08, 0x70},{ 3, 0x07, 0x08, 0x70},{0x00}},             /* /  (2f) */
    {{ 4, 0x3e, 0x41, 0x41 , 0x3e},{ 3, 0x3e, 0x41, 0x3e},{0x3f}},      /* 0  (30) */
    {{ 3, 0x21, 0x7f, 0x01},{ 2, 0x20, 0x7f},{0x06}},                   /* 1  (31) */
    {{ 4, 0x23, 0x45, 0x49, 0x31},{ 3, 0x27, 0x49, 0x31},{0x5b}},       /* 2  (32) */
    {{ 4, 0x22, 0x49, 0x49, 0x36},{ 3, 0x22, 0x49, 0x36},{0x4f}},       /* 3  (33) */
    {{ 4, 0x78, 0x08, 0x08, 0x7f},{ 3, 0x78, 0x08, 0x7f},{0x66}},       /* 4  (34) */
    {{ 4, 0x72, 0x51, 0x51, 0x4e},{ 3, 0x72, 0x51, 0x4e},{0x6d}},       /* 5  (35) */
    {{ 4, 0x3e, 0x49, 0x49, 0x26},{ 3, 0x3e, 0x49, 0x46},{0x7d}},       /* 6  (36) */
    {{ 4, 0x40, 0x47, 0x48, 0x70},{ 3, 0x40, 0x47, 0x78},{0x07}},       /* 7  (37) */
    {{ 4, 0x36, 0x49, 0x49, 0x36},{ 3, 0x36, 0x49, 0x36},{0x7f}},       /* 8  (38) */
    {{ 4, 0x30, 0x48, 0x48, 0x3f},{ 3, 0x30, 0x49, 0x3e},{0x67}},       /* 9  (39) */
    {{ 1, 0x24},{ 1, 0x24},{0x00}},                                     /* :  (3a) */
    {{ 1, 0x27},{ 1, 0x27},{0x00}},                                     /* ;  (3b) */
    {{ 4, 0x08, 0x14, 0x22, 0x41},{ 4, 0x08, 0x14, 0x22, 0x41},{0x00}}, /* <  (3c) */
    {{ 4, 0x14, 0x14, 0x14, 0x14},{ 4, 0x14, 0x14, 0x14, 0x14},{0x00}}, /* =  (3d) */
    {{ 4, 0x41, 0x22, 0x14, 0x08},{ 4, 0x41, 0x22, 0x14, 0x08},{0x00}}, /* >  (3e) */
    {{ 4, 0x20, 0x40, 0x4d, 0x30},{ 4, 0x20, 0x40, 0x4d, 0x30},{0x00}}, /* ?  (3f) */
    {{ 4, 0x26, 0x4d, 0x4d, 0x3e},{ 4, 0x26, 0x4d, 0x4d, 0x3e},{0x00}}, /* @  (40) */
    {{ 4, 0x3f, 0x48, 0x48, 0x3f},{ 4, 0x3f, 0x48, 0x48, 0x3f},{0x77}}, /* A  (41) */
    {{ 4, 0x7f, 0x49, 0x49, 0x36},{ 4, 0x7f, 0x49, 0x49, 0x36},{0x7c}}, /* B  (42) */
    {{ 4, 0x3e, 0x41, 0x41, 0x22},{ 4, 0x3e, 0x41, 0x41, 0x22},{0x39}}, /* C  (43) */
    {{ 4, 0x7f, 0x41, 0x41, 0x3e},{ 4, 0x7f, 0x41, 0x41, 0x3e},{0x5e}}, /* D  (44) */
    {{ 4, 0x7f, 0x49, 0x49, 0x41},{ 4, 0x7f, 0x49, 0x49, 0x41},{0x79}}, /* E  (45) */
    {{ 4, 0x7f, 0x48, 0x48, 0x40},{ 4, 0x7f, 0x48, 0x48, 0x40},{0x71}}, /* F  (46) */
    {{ 4, 0x3e, 0x41, 0x49, 0x2e},{ 4, 0x3e, 0x41, 0x49, 0x2e},{0x7d}}, /* G  (47) */
    {{ 4, 0x7f, 0x08, 0x08, 0x7f},{ 4, 0x7f, 0x08, 0x08, 0x7f},{0x76}}, /* H  (48) */
    {{ 3, 0x41, 0x7f, 0x41},{ 3, 0x41, 0x7f, 0x41},{0x06}},             /* I  (49) */
    {{ 3, 0x02, 0x41, 0x7e},{ 3, 0x02, 0x41, 0x7e},{0x0e}},             /* J  (4a) */
    {{ 4, 0x7f, 0x14, 0x22, 0x41},{ 4, 0x7f, 0x14, 0x22, 0x41},{0x00}}, /* K  (4b) */
    {{ 4, 0x7f, 0x01, 0x01, 0x01},{ 4, 0x7f, 0x01, 0x01, 0x01},{0x38}}, /* L  (4c) */
    {{ 3, 0x7f, 0x30, 0x7f},{ 3, 0x7f, 0x30, 0x7f},{0x00}},             /* M  (4d) */
    {{ 4, 0x7f, 0x18, 0x0c, 0x7f},{ 4, 0x7f, 0x18, 0x0c, 0x7f},{0x54}}, /* N  (4e) */
    {{ 4, 0x3e, 0x41, 0x41, 0x3e},{ 4, 0x3e, 0x41, 0x41, 0x3e},{0x3f}}, /* O  (4f) */
    {{ 4, 0x7f, 0x48, 0x48, 0x30},{ 4, 0x7f, 0x48, 0x48, 0x30},{0x73}}, /* P  (50) */
    {{ 4, 0x3e, 0x41, 0x42, 0x3d},{ 4, 0x3e, 0x41, 0x42, 0x3d},{0x00}}, /* Q  (51) */
    {{ 4, 0x7f, 0x4c, 0x4a, 0x31},{ 4, 0x7f, 0x4c, 0x4a, 0x31},{0x50}}, /* R  (52) */
    {{ 4, 0x32, 0x49, 0x49, 0x26},{ 4, 0x32, 0x49, 0x49, 0x26},{0x6d}}, /* S  (53) */
    {{ 3, 0x40, 0x7f, 0x40},{ 3, 0x40, 0x7f, 0x40},{0x78}},             /* T  (54) */
    {{ 4, 0x7e, 0x01, 0x01, 0x7e},{ 4, 0x7e, 0x01, 0x01, 0x7e},{0x3e}}, /* U  (55) */
    {{ 4, 0x7c, 0x03, 0x03, 0x7c},{ 4, 0x7c, 0x03, 0x03, 0x7c},{0x00}}, /* V  (56) */
    {{ 4, 0x7f, 0x06, 0x06, 0x7f},{ 4, 0x7f, 0x06, 0x06, 0x7f},{0x00}}, /* W  (57) */
    {{ 4, 0x67, 0x18, 0x18, 0x67},{ 4, 0x67, 0x18, 0x18, 0x67},{0x00}}, /* X  (58) */
    {{ 3, 0x60, 0x1f, 0x60},{ 3, 0x60, 0x1f, 0x60},{0x00}},             /* Y  (59) */
    {{ 4, 0x43, 0x45, 0x49, 0x71},{ 4, 0x43, 0x45, 0x49, 0x71},{0x00}}, /* Z  (5a) */
    {{ 3, 0x7f, 0x41, 0x41},{ 3, 0x7f, 0x41, 0x41},{0x00}},             /* [  (5b) */
    {{ 3, 0x70, 0x08, 0x07},{ 3, 0x70, 0x08, 0x07},{0x00}},             /* \  (5c) */
    {{ 3, 0x41, 0x41, 0x7f},{ 3, 0x41, 0x41, 0x7f},{0x00}},             /* ]  (5d) */
    {{ 3, 0x20, 0x50, 0x20},{ 3, 0x20, 0x50, 0x20},{0x63}},             /* ^  (5e) */
    {{ 3, 0x01, 0x01, 0x01},{ 3, 0x01, 0x01, 0x01},{0x08}},             /* _  (5f) */
    {{ 2, 0x70, 0x68},{ 2, 0x70, 0x68},{0x00}},                         /* '  (60) */
    {{ 3, 0x12, 0x15, 0x0f},{ 3, 0x12, 0x15, 0x0f},{0x77}},             /* a  (61) */
    {{ 3, 0x1f, 0x05, 0x02},{ 3, 0x1f, 0x05, 0x02},{0x7c}},             /* b  (62) */
    {{ 3, 0x02, 0x05, 0x05},{ 3, 0x02, 0x05, 0x05},{0x39}},             /* c  (63) */
    {{ 3, 0x02, 0x05, 0x1f},{ 3, 0x02, 0x05, 0x1f},{0x5e}},             /* d  (64) */
    {{ 3, 0x06, 0x0d, 0x05},{ 3, 0x06, 0x0d, 0x05},{0x79}},             /* e  (65) */
    {{ 3, 0x04, 0x0f, 0x14},{ 3, 0x04, 0x0f, 0x14},{0x71}},             /* f  (66) */
    {{ 3, 0x05, 0x0d, 0x06},{ 3, 0x05, 0x0d, 0x06},{0x7d}},             /* g  (67) */
    {{ 3, 0x1f, 0x04, 0x03},{ 3, 0x1f, 0x04, 0x03},{0x76}},             /* h  (68) */
    {{ 3, 0x05, 0x17, 0x01},{ 3, 0x05, 0x17, 0x01},{0x06}},             /* i  (69) */
    {{ 3, 0x05, 0x16, 0x04},{ 3, 0x05, 0x16, 0x04},{0x0e}},             /* j  (6a) */
    {{ 3, 0x1f, 0x02, 0x05},{ 3, 0x1f, 0x02, 0x05},{0x00}},             /* k  (6b) */
    {{ 3, 0x11, 0x1f, 0x01},{ 3, 0x11, 0x1f, 0x01},{0x38}},             /* l  (6c) */
    {{ 3, 0x0f, 0x06, 0x03},{ 3, 0x0f, 0x06, 0x03},{0x00}},             /* m  (6d) */
    {{ 3, 0x0f, 0x04, 0x03},{ 3, 0x0f, 0x04, 0x03},{0x54}},             /* n  (6e) */
    {{ 3, 0x06, 0x09, 0x06},{ 3, 0x06, 0x09, 0x06},{0x3f}},             /* o  (6f) */
    {{ 3, 0x0f, 0x0a, 0x04},{ 3, 0x0f, 0x0a, 0x04},{0x73}},             /* p  (70) */
    {{ 3, 0x04, 0x0a, 0x0f},{ 3, 0x04, 0x0a, 0x0f},{0x00}},             /* q  (71) */
    {{ 3, 0x0f, 0x04, 0x08},{ 3, 0x0f, 0x04, 0x08},{0x50}},             /* r  (72) */
    {{ 3, 0x05, 0x0d, 0x0a},{ 3, 0x05, 0x0d, 0x0a},{0x6d}},             /* s  (73) */
    {{ 3, 0x08, 0x1e, 0x09},{ 3, 0x08, 0x1e, 0x09},{0x78}},             /* t  (74) */
    {{ 3, 0x0e, 0x01, 0x0f},{ 3, 0x0e, 0x01, 0x0f},{0x3e}},             /* u  (75) */
    {{ 3, 0x0e, 0x01, 0x0e},{ 3, 0x0e, 0x01, 0x0e},{0x00}},             /* v  (76) */
    {{ 3, 0x0e, 0x03, 0x0e},{ 3, 0x0e, 0x03, 0x0e},{0x00}},             /* w  (77) */
    {{ 3, 0x09, 0x06, 0x09},{ 3, 0x09, 0x06, 0x09},{0x00}},             /* x  (78) */
    {{ 3, 0x0d, 0x05, 0x0e},{ 3, 0x0d, 0x05, 0x0e},{0x00}},             /* y  (79) */
    {{ 3, 0x09, 0x0b, 0x0d},{ 3, 0x09, 0x0b, 0x0d},{0x00}},             /* z  (7a) */
    {{ 3, 0x08, 0x36, 0x41},{ 3, 0x08, 0x36, 0x41},{0x00}},             /* {  (7b) */
    {{ 1, 0x3e},{ 1, 0x3e},{0x00}},                                     /* |  (7c) */
    {{ 3, 0x41, 0x36, 0x08},{ 3, 0x41, 0x36, 0x08},{0x00}},             /* }  (7d) */
    {{ 4, 0x20, 0x40, 0x20, 0x40},{ 4, 0x20, 0x40, 0x20, 0x40},{0x01}}, /* ~  (7e) */
    {{ 3, 0x2a, 0x55, 0x2a},{ 3, 0x2a, 0x55, 0x2a},{0x00}}              /* #  (7f) */
} ;

__farflash const char DispDrv140[][3] = { // Column drive
//Port  A,    C,    G
    {0x01, 0x00, 0x00}, 
    {0x02, 0x00, 0x00}, 
    {0x04, 0x00, 0x00}, 
    {0x08, 0x00, 0x00}, 
    {0x10, 0x00, 0x00}, 
    {0x20, 0x00, 0x00}, 
    {0x40, 0x00, 0x00}, 
    {0x80, 0x00, 0x00}, 
    {0x00, 0x01, 0x00}, 
    {0x00, 0x02, 0x00}, 
    {0x00, 0x04, 0x00}, 
    {0x00, 0x08, 0x00}, 
    {0x00, 0x10, 0x00}, 
    {0x00, 0x20, 0x00}, 
    {0x00, 0x40, 0x00}, 
    {0x00, 0x80, 0x00}, 
    {0x00, 0x00, 0x01}, 
    {0x00, 0x00, 0x02}, 
    {0x00, 0x00, 0x04}, 
    {0x00, 0x00, 0x08} 
} ;
__farflash const char DispArr196[] = { // Column drive
//column 8 - 19
    16,  
    15, 
    14, 
    13, 
    12, 
    11, 
    10, 
    9, 
    18, 
    17, 
    8   
};

