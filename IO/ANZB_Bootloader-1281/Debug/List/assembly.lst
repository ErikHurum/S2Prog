###############################################################################
#                                                                             #
#     IAR Assembler V7.30.5.1680/W32 for Microchip AVR 13/Feb/2024  15:22:07  #
#     Copyright 2022 IAR Systems AB.                                          #
#                                                                             #
#           Target option =  Relative jumps do not wrap                       #
#           Source file   =  C:\Users\ESY\OneDrive - Scanjet\Documents\GitHub\S2Prog\IO\ANZB_Bootloader-1281\Asm\assembly.s90#
#           List file     =  C:\Users\ESY\OneDrive - Scanjet\Documents\GitHub\S2Prog\IO\ANZB_Bootloader-1281\Debug\List\assembly.lst#
#           Object file   =  C:\Users\ESY\OneDrive - Scanjet\Documents\GitHub\S2Prog\IO\ANZB_Bootloader-1281\Debug\Obj\assembly.r90#
#           Command line  =  -f C:\Users\ESY\AppData\Local\Temp\EW9D59.tmp    #
#                            (C:\Users\ESY\OneDrive - Scanjet\Documents\GitHub\S2Prog\IO\ANZB_Bootloader-1281\Asm\assembly.s90 #
#                            -v3                                              #
#                            -OC:\Users\ESY\OneDrive - Scanjet\Documents\GitHub\S2Prog\IO\ANZB_Bootloader-1281\Debug\Obj #
#                            -s+ -w+ -r -DENABLE_BIT_DEFINITIONS              #
#                            -DLARGE_MEMORY -D__ATMEGA_1281__ -M<>            #
#                            -LC:\Users\ESY\OneDrive - Scanjet\Documents\GitHub\S2Prog\IO\ANZB_Bootloader-1281\Debug\List #
#                            -t8 -u_enhancedCore -D__HAS_ENHANCED_CORE__=1    #
#                            -D__HAS_MUL__=1                                  #
#                            -IC:\Program Files (x86)\IAR Systems\Embedded Workbench 8.4\avr\INC\\ #
#                            -IC:\Users\ESY\OneDrive - Scanjet\Documents\GitHub\S2Prog\IO\ANZB_Bootloader-1281\INC\\ #
#                            -D__MEMORY_MODEL__=2 -D__ATmega1281__=1          #
#                            -D__HAS_ELPM__=1)                                #
#                                                                             #
###############################################################################

      1    00000000                      NAME    assembly(16)
      2    00000000                      PUBLIC  fill_temp_buffer
      3    00000000                      PUBLIC  write_page
      4    00000000                      PUBLIC  write_lock_bits
      5    00000000                      PUBLIC  read_program_memory
      6    00000000                      RSEG    CODE
      7    00000000              
      8    00000000              
      9    00000000              #ifdef __ATMEGA_1280__
     11    00000000              #endif
     12    00000000              
     13    00000000              #ifdef __ATMEGA_1281__
     14    00000000              #include        "iom1281.h"
     15    00000000              #endif
     16    00000000              
     17    00000000              write_page:
     18    00000000 D01F                 RCALL   WAIT_SPMEN  ;Wait for SPMEN
                                                              flag cleared
     19    00000002 2FF1                 MOV     R31,R17         
     20    00000004 2FE0                 MOV     R30,R16     ;move adress to z
                                                              pointer (R31=ZH
                                                              R30=ZL)
     21    00000006 BF27                 OUT     SPMCSR, R18     ; argument 2
                                                                  decides
                                                                  function
                                                                  (r18)
     22    00000008 95E8                 SPM
     23    0000000A C01A                 RJMP    WAIT_SPMEN ;Wait for SPMEN
                                                             flag cleared
     24    0000000C              
     25    0000000C              
     26    0000000C              fill_temp_buffer:
     27    0000000C D019                 RCALL   WAIT_SPMEN  ;Wait for SPMEN
                                                              flag cleared
     28    0000000E 2FF3                 MOV     R31,R19     ;move adress to z
                                                              pointer (R31=ZH
                                                              R30=ZL)  
                                                              
     29    00000010 2FE2                 MOV     R30,R18     
     30    00000012 2E11                 MOV     R1,R17      ;move data to reg
                                                              0 and 1     
                                                              
     31    00000014 2E00                 MOV     R0,R16
     32    00000016                      
     33    00000016 E021                 LDI     R18,(1<<SPMEN)
     34    00000018 BF27                 OUT     SPMCSR, R18    ; r18 decides
                                                                 function
     35    0000001A 95E8                 SPM
     36    0000001C C011                 RJMP   WAIT_SPMEN  ;Wait for SPMEN
                                                             flag cleared
     37    0000001E              
     38    0000001E              
     39    0000001E              read_program_memory:
     40    0000001E D010                 RCALL    WAIT_SPMEN
     41    00000020 2FF1                 MOV     R31,R17     ;R31=ZH R30=ZL
     42    00000022 2FE0                 MOV     R30,R16     ;move adress to z
                                                              pointer
     43    00000024 FD20                 SBRC    R18,0       ;read lockbits?
                                                              (second
                                                              argument=0x09)
     44    00000026                                          ;if so, place
                                  second argument in SPMEN register
     45    00000026 BF27                 OUT     SPMCSR, R18     ; r18 decides
                                                                  function
     46    00000028                      
     47    00000028 95D8                 ELPM                ;read LSB       
                                                              
     48    0000002A              
     49    0000002A 2D00                 MOV     R16,R0      ;read LSB         
                                                               
     50    0000002C 95E3                 INC     R30
     51    0000002E              
     52    0000002E 95D8                 ELPM                ;read LSB       
                                                              
     53    00000030              
     54    00000030 2D10                 MOV     R17,R0      ;read MSB (ignored
                                                              when reading
                                                              lockbits)
     55    00000032 9508                 RET
     56    00000034              
     57    00000034              
     58    00000034              write_lock_bits:
     59    00000034 D005                 RCALL   WAIT_SPMEN  ;Wait for SPMEN
                                                              flag cleared
     60    00000036 2E00                 MOV     R0,R16   
     61    00000038 E029                 LDI     R18,((1<<BLBSET)|(1<<SPMEN))
     62    0000003A              
     63    0000003A BF27                 OUT     SPMCSR, R18    ; r18 decides
                                                                 function
     64    0000003C 95E8                 SPM                ;write lockbits
     65    0000003E C000                 RJMP   WAIT_SPMEN  ;Wait for SPMEN
                                                             flag cleared
     66    00000040                      
     67    00000040              
     68    00000040              WAIT_SPMEN:
     69    00000040 2E02                     MOV         R0, R18
     70    00000042 B727                 IN      R18, SPMCSR      ; get SPMCR
                                                                   into
                                                                   r18
     71    00000044 FD20                 SBRC    R18,SPMEN
     72    00000046 CFFC                 RJMP    WAIT_SPMEN  ;Wait for SPMEN
                                                              flag cleared
     73    00000048 2D20                 MOV             R18, R0
     74    0000004A              
     75    0000004A 9508                 RET
     76    0000004C              
     77    0000004C              
     78    0000004C              END
##############################
#          CRC:B543          #
#        Errors:   0         #
#        Warnings: 0         #
#         Bytes: 76          #
##############################



